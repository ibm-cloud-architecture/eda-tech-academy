<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jerome Boyer"><link href=kstream/ rel=prev><link href=lab2-sol/ rel=next><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.6"><title>Lab 2 exercises - EDA technical academy</title><link rel=stylesheet href=../assets/stylesheets/main.558e4712.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#lab-2-store-inventory-with-kafka-streams class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="EDA technical academy" class="md-header__button md-logo" aria-label="EDA technical academy" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EDA technical academy </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Lab 2 exercises </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Introduction </a> </li> <li class=md-tabs__item> <a href=../eda/ class=md-tabs__link> Information </a> </li> <li class=md-tabs__item> <a href=../getting-started/ class=md-tabs__link> Journey 1 </a> </li> <li class=md-tabs__item> <a href=../lab1/ class="md-tabs__link md-tabs__link--active"> Journey 2 </a> </li> <li class=md-tabs__item> <a href=../future/ class=md-tabs__link> More... </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="EDA technical academy" class="md-nav__button md-logo" aria-label="EDA technical academy" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> EDA technical academy </label> <div class=md-nav__source> <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 tabindex=0 aria-expanded=false> Information <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Information data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Information </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../eda/ class=md-nav__link> Why EDA now? </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-eda/concepts/fit-to-purpose/ class=md-nav__link> Fit for purpose </a> </li> <li class=md-nav__item> <a href=https://ibm-cloud-architecture.github.io/refarch-eda/introduction/reference-architecture/#event-driven-architecture class=md-nav__link> EDA Reference Architecture </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 tabindex=0 aria-expanded=false> Journey 1 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journey 1" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Journey 1 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../getting-started/ class=md-nav__link> Getting started with Event Streams </a> </li> <li class=md-nav__item> <a href=../getting-started/schema-lab/ class=md-nav__link> Event Streams schema </a> </li> <li class=md-nav__item> <a href=../getting-started/eepm/ class=md-nav__link> Event-endpoint management </a> </li> <li class=md-nav__item> <a href=../getting-started/mm2/ class=md-nav__link> Mirror maker 2 lab </a> </li> <li class=md-nav__item> <a href=../demo/ class=md-nav__link> Demonstration A to Z </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 tabindex=0 aria-expanded=true> Journey 2 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journey 2" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Journey 2 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 tabindex=0 aria-expanded=false> Lab 1 - System Design Lab <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Lab 1 - System Design Lab" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Lab 1 - System Design Lab </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../lab1/ class=md-nav__link> Problem Statement </a> </li> <li class=md-nav__item> <a href=../lab1/lab1-sol/ class=md-nav__link> Solution Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2 checked> <label class=md-nav__link for=__nav_4_2 tabindex=0 aria-expanded=true> Kafka Streams Lab <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Kafka Streams Lab" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Kafka Streams Lab </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=kstream/ class=md-nav__link> Kafka Streams Study </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Lab 2 exercises <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Lab 2 exercises </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> </li> <li class=md-nav__item> <a href=#context class=md-nav__link> Context </a> </li> <li class=md-nav__item> <a href=#step-by-step-exercises class=md-nav__link> Step by step exercises </a> <nav class=md-nav aria-label="Step by step exercises"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#exercise-1-test-your-first-topology class=md-nav__link> Exercise 1: Test your first topology </a> </li> <li class=md-nav__item> <a href=#exercise-2-filter-item-transaction-without-a-store class=md-nav__link> Exercise 2: Filter item transaction without a store </a> </li> <li class=md-nav__item> <a href=#exercise-3-dead-letter-topic class=md-nav__link> Exercise 3: Dead letter topic </a> </li> <li class=md-nav__item> <a href=#exercice-4-using-ktable class=md-nav__link> Exercice 4 - Using Ktable </a> </li> <li class=md-nav__item> <a href=#more-examples class=md-nav__link> More examples </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#final-store-inventory-exercice class=md-nav__link> Final store inventory exercice </a> <nav class=md-nav aria-label="Final store inventory exercice"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#problem-statement class=md-nav__link> Problem statement </a> </li> <li class=md-nav__item> <a href=#design-questions class=md-nav__link> Design questions </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=lab2-sol/ class=md-nav__link> Solution Overview </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../lab3/ class=md-nav__link> Lab 3 - Real Time Inventory demo </a> </li> <li class=md-nav__item> <a href=../lab4/ class=md-nav__link> Lab 4 - EDA GitOps </a> </li> <li class=md-nav__item> <a href=../lab5/ class=md-nav__link> Lab 5 - Monitoring with Instana </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../future/ class=md-nav__link> More... </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> </li> <li class=md-nav__item> <a href=#context class=md-nav__link> Context </a> </li> <li class=md-nav__item> <a href=#step-by-step-exercises class=md-nav__link> Step by step exercises </a> <nav class=md-nav aria-label="Step by step exercises"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#exercise-1-test-your-first-topology class=md-nav__link> Exercise 1: Test your first topology </a> </li> <li class=md-nav__item> <a href=#exercise-2-filter-item-transaction-without-a-store class=md-nav__link> Exercise 2: Filter item transaction without a store </a> </li> <li class=md-nav__item> <a href=#exercise-3-dead-letter-topic class=md-nav__link> Exercise 3: Dead letter topic </a> </li> <li class=md-nav__item> <a href=#exercice-4-using-ktable class=md-nav__link> Exercice 4 - Using Ktable </a> </li> <li class=md-nav__item> <a href=#more-examples class=md-nav__link> More examples </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#final-store-inventory-exercice class=md-nav__link> Final store inventory exercice </a> <nav class=md-nav aria-label="Final store inventory exercice"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#problem-statement class=md-nav__link> Problem statement </a> </li> <li class=md-nav__item> <a href=#design-questions class=md-nav__link> Design questions </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=lab-2-store-inventory-with-kafka-streams>Lab 2: Store inventory with Kafka Streams<a class=headerlink href=#lab-2-store-inventory-with-kafka-streams title="Permanent link">&para;</a></h1> <p>In this Lab, you will learn simple Kafka Streams exercises using Java APIs, and then finish by implementing on of the proof of concept component to compute the store inventory for each items sold.</p> <h2 id=pre-requisites>Pre-requisites<a class=headerlink href=#pre-requisites title="Permanent link">&para;</a></h2> <p>This lab requires some java experience. <br> Be sure to have completed the pre-requisites listed <a href=../lab1/ >here</a></p> <ul> <li>Be sure your IDE, like VScode has java extension. For VSCode you can use <a href="https://marketplace.visualstudio.com/items?itemName=redhat.java">Red Hat java extension</a></li> <li>maven is used to package and run some test. The project has <code>./mvnw</code> command that brings maven in the project.</li> <li>Open Visual Code. Click on “Open Java Project” and pick the refarch-eda-store-inventory from the <code>eda-tech-academy\lab2\</code> folder </li> </ul> <p>From there, select / modify the java code and run it from Visual Code.</p> <h2 id=context>Context<a class=headerlink href=#context title="Permanent link">&para;</a></h2> <p>The figure illustrates what you need to build, the green rectangle, which is a Java application using Kafka Streams API consuming <code>items</code> events and computing <code>store inventory</code> events by aggregating at the store level.</p> <p><img alt src=../images/store-inv.png></p> <p>In fact, most of the code is already done for you, and the lab is to help you building event streaming knowledge by increment. At the end of this training you should be able to reuse this approach in your future work. All the development is done by running on your local computer, not need to deploy to OpenShift.</p> <p>In the global view of the real-time inventory solution presented in the lab 1, the goal is to do the store aggregation processing.</p> <h2 id=step-by-step-exercises>Step by step exercises<a class=headerlink href=#step-by-step-exercises title="Permanent link">&para;</a></h2> <p>Before implementing the store inventory, you need to learn Kafka streams programming with a set of simple exercises. </p> <p>Review the <a href=./kstream/ >Kafka Streams API concepts and basic APIs here</a>.</p> <p>To do the hands-on exerices, go to the <code>/lab2/refarch-eda-store-inventory</code> folder of this repository, load this folder into your IDE. Be sure you can run tests inside the IDE, it may be easier to debug.</p> <p><img alt src=images/vscode-ide.png></p> <h3 id=exercise-1-test-your-first-topology>Exercise 1: Test your first topology<a class=headerlink href=#exercise-1-test-your-first-topology title="Permanent link">&para;</a></h3> <p><strong>Duration: 10 minutes</strong></p> <p><strong>Goal:</strong> Test a basic topology inside unit test.</p> <p>In your IDE go to the <code>src/test/java/ut</code> folder and open the class: <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/test/java/ut/TestYourFirstTopology.java>TestYourFirstTopology.java</a>. The most important elements of this test are:</p> <ul> <li>The <code>TopologyTestDriver</code> is a class to test a Kafka Streams topology without Kafka. It uses dummy configuration.</li> <li>the <code>TestInputTopic</code> class is used to pipe test records to a topic in TopologyTestDriver. This is used to send test messages. The creation of this instance needs to specify the serializer or deserialer used.</li> <li>The <code>@BeforeAll</code> annotation on the <code>setup()</code> method means that it will be run before any test is executed, while the <code>@AfterAll</code> annotation on the teardown method ensures that it will be run after last test execution. We use this approach to define the topology under test in this class.</li> </ul> <div class=highlight><span class=filename>Build test driver and topics</span><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.streams.StreamsConfig</span><span class=p>;</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.streams.TestInputTopic</span><span class=p>;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.streams.TestOutputTopic</span><span class=p>;</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.streams.TopologyTestDriver</span><span class=p>;</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.common.serialization.StringDeserializer</span><span class=p>;</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.common.serialization.StringSerializer</span><span class=p>;</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=c1>//...</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=n>Topology</span><span class=w> </span><span class=n>topology</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildTopologyFlow</span><span class=p>();</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=n>testDriver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TopologyTestDriver</span><span class=p>(</span><span class=n>topology</span><span class=p>,</span><span class=w> </span><span class=n>getStreamsConfig</span><span class=p>());</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=n>inTopic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testDriver</span><span class=p>.</span><span class=na>createInputTopic</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringSerializer</span><span class=p>(),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringSerializer</span><span class=p>());</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=n>outTopic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testDriver</span><span class=p>.</span><span class=na>createOutputTopic</span><span class=p>(</span><span class=n>outTopicName</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringDeserializer</span><span class=p>(),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringDeserializer</span><span class=p>());</span><span class=w> </span>
</code></pre></div> <ul> <li>The <code>buildTopology</code> method utilizes the <code>StreamsBuilder</code> class to construct a simple Kafka Streams topology, reading from the input Kafka topic defined by the inTopicName String. The logic is simply to print the message, the filter on a <code>blue</code> value, and generates the output to a topic:</li> </ul> <div class=highlight><span class=filename>buildTopology(): Filter text message topology</span><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>basicColors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>(),</span><span class=w> </span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>()));</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>basicColors</span><span class=p>.</span><span class=na>peek</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;PRE-FILTER: key=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, value=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=p>))</span><span class=w> </span><span class=c1>// (1)</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>(</span><span class=s>&quot;BLUE&quot;</span><span class=p>.</span><span class=na>equalsIgnoreCase</span><span class=p>(</span><span class=n>value</span><span class=p>)))</span><span class=w> </span><span class=c1>// (2)</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=p>.</span><span class=na>peek</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;POST-FILTER: key=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, value=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=p>))</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=n>outTopicName</span><span class=p>);</span><span class=w> </span><span class=c1>// (3)</span>
</code></pre></div> <ol> <li><code>Peek()</code> to get the message, apply a lambda function and do nothing else. Used for printing</li> <li><code>filter()</code> to select records. So here there is a transformation of the input kstream and output kstream</li> <li><code>to()</code> is to output the stream to a topic.</li> </ol> <p>Run this test you should see the following output in the Debug Console. <br> If your IDE is Visual Studio Code, click the "Run Tests" icon right of TestYourFirstTopology on the explorer. <br> <img alt src=images/vs_run.png>.<br> The first part is a print of the defined topology and then the execution of the topology on the different input records. </p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>Topologies:
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>   </span>Sub-topology:<span class=w> </span><span class=m>0</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span>Source:<span class=w> </span>KSTREAM-SOURCE-0000000000<span class=w> </span><span class=o>(</span>topics:<span class=w> </span><span class=o>[</span>my-input-topic<span class=o>])</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>      </span>--&gt;<span class=w> </span>KSTREAM-PEEK-0000000001
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span>Processor:<span class=w> </span>KSTREAM-PEEK-0000000001<span class=w> </span><span class=o>(</span>stores:<span class=w> </span><span class=o>[])</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>      </span>--&gt;<span class=w> </span>KSTREAM-FILTER-0000000002
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>      </span>&lt;--<span class=w> </span>KSTREAM-SOURCE-0000000000
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span>Processor:<span class=w> </span>KSTREAM-FILTER-0000000002<span class=w> </span><span class=o>(</span>stores:<span class=w> </span><span class=o>[])</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>      </span>--&gt;<span class=w> </span>KSTREAM-PEEK-0000000003
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>      </span>&lt;--<span class=w> </span>KSTREAM-PEEK-0000000001
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span>Processor:<span class=w> </span>KSTREAM-PEEK-0000000003<span class=w> </span><span class=o>(</span>stores:<span class=w> </span><span class=o>[])</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>      </span>--&gt;<span class=w> </span>KSTREAM-SINK-0000000004
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>      </span>&lt;--<span class=w> </span>KSTREAM-FILTER-0000000002
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>    </span>Sink:<span class=w> </span>KSTREAM-SINK-0000000004<span class=w> </span><span class=o>(</span>topic:<span class=w> </span>my-output-topic<span class=o>)</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>      </span>&lt;--<span class=w> </span>KSTREAM-PEEK-0000000003
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=o>[</span>or.ap.ka.st.pr.in.StreamTask<span class=o>]</span><span class=w> </span><span class=o>(</span>main<span class=o>)</span><span class=w> </span>stream-thread<span class=w> </span><span class=o>[</span>main<span class=o>]</span><span class=w> </span>task<span class=w> </span><span class=o>[</span>0_0<span class=o>]</span><span class=w> </span>Initialized
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=o>[</span>or.ap.ka.st.pr.in.StreamTask<span class=o>]</span><span class=w> </span><span class=o>(</span>main<span class=o>)</span><span class=w> </span>stream-thread<span class=w> </span><span class=o>[</span>main<span class=o>]</span><span class=w> </span>task<span class=w> </span><span class=o>[</span>0_0<span class=o>]</span><span class=w> </span>Restored<span class=w> </span>and<span class=w> </span>ready<span class=w> </span>to<span class=w> </span>run
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>PRE-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C01,<span class=w> </span><span class=nv>value</span><span class=o>=</span>blue
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>POST-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C01,<span class=w> </span><span class=nv>value</span><span class=o>=</span>blue
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>PRE-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C02,<span class=w> </span><span class=nv>value</span><span class=o>=</span>red
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>PRE-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C03,<span class=w> </span><span class=nv>value</span><span class=o>=</span>green
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>PRE-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C04,<span class=w> </span><span class=nv>value</span><span class=o>=</span>Blue
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>POST-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C04,<span class=w> </span><span class=nv>value</span><span class=o>=</span>Blue
<a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>PRE-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C01,<span class=w> </span><span class=nv>value</span><span class=o>=</span>blue
<a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>POST-FILTER:<span class=w> </span><span class=nv>key</span><span class=o>=</span>C01,<span class=w> </span><span class=nv>value</span><span class=o>=</span>blue
<a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=o>[</span>or.ap.ka.st.pr.in.StreamTask<span class=o>]</span><span class=w> </span><span class=o>(</span>main<span class=o>)</span><span class=w> </span>stream-thread<span class=w> </span><span class=o>[</span>main<span class=o>]</span><span class=w> </span>task<span class=w> </span><span class=o>[</span>0_0<span class=o>]</span><span class=w> </span>Suspended<span class=w> </span>running
<a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=o>[</span>or.ap.ka.st.pr.in.RecordCollectorImpl<span class=o>]</span><span class=w> </span><span class=o>(</span>main<span class=o>)</span><span class=w> </span>topology-test-driver<span class=w> </span>Closing<span class=w> </span>record<span class=w> </span>collector<span class=w> </span>clean
<a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a><span class=o>[</span>or.ap.ka.st.pr.in.StreamTask<span class=o>]</span><span class=w> </span><span class=o>(</span>main<span class=o>)</span><span class=w> </span>stream-thread<span class=w> </span><span class=o>[</span>main<span class=o>]</span><span class=w> </span>task<span class=w> </span><span class=o>[</span>0_0<span class=o>]</span><span class=w> </span>Closed<span class=w> </span>clean
</code></pre></div> <p>See comments in test class for more information. May be you can play with the data, and change the filter condition. </p> <h3 id=exercise-2-filter-item-transaction-without-a-store>Exercise 2: Filter item transaction without a store<a class=headerlink href=#exercise-2-filter-item-transaction-without-a-store title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> Given item sold transactions, keep transactions with store and sku information populated.</p> <p>Try to do a topology taking the <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/main/java/ibm/gse/eda/stores/domain/ItemTransaction.java>ItemTransaction class</a> as the code defining the content from the input topic. The following code does not need to be copied/paste. It is here to explain you the structure of the data. The class is in the classpath, so tests run in maven or in the IDE will work.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ItemTransaction</span><span class=w>   </span><span class=p>{</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;RESTOCK&quot;</span><span class=p>;</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>SALE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;SALE&quot;</span><span class=p>;</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>storeName</span><span class=p>;</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sku</span><span class=p>;</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>quantity</span><span class=p>;</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>type</span><span class=p>;</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>Double</span><span class=w> </span><span class=n>price</span><span class=p>;</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>timestamp</span><span class=p>;</span>
</code></pre></div> <p>So the Stream Topology needs to use the <code>filter()</code> function to select items with valid sku and storeName.</p> <p>You should use the <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/test/java/ut/TestSecondTopology.java>TestSecondTopology test class</a>, and implement the Kafka Streams topology in the <code>buildTopologyFlow()</code> method:</p> <div class=highlight><span class=filename>Build filtering</span><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Topology</span><span class=w> </span><span class=nf>buildTopologyFlow</span><span class=p>(){</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>StreamsBuilder</span><span class=w> </span><span class=n>builder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StreamsBuilder</span><span class=p>();</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>         </span><span class=c1>// 1- get the input stream</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>        </span><span class=c1>// 2 filter</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>        </span><span class=c1>// Generate to output topic</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>  </span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>    </span><span class=p>}</span>
</code></pre></div> <p>In the first exercice, we used String Deserializer. This time we need Java Bean serializer/deserializer. This is a classical task in any Kafka Streams projects to have to define such serdes. The Serialization and Deserialization are defined in the <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/main/java/ibm/gse/eda/stores/infra/events/StoreSerdes.java>StoreSerdes.class</a> which uses a <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/main/java/ibm/gse/eda/stores/infra/events/JSONSerde.java>JSON generic class</a> based on Jackson parser. You should be able to reuse this class in all your project.</p> <p>Do not copy / past the following code. This is just for information so you can see the relationship between Serdes and the Java bean they are supposed to deserialize.</p> <div class=highlight><span class=filename>JSONSerdes</span><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.common.serialization.Deserializer</span><span class=p>;</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.common.serialization.Serde</span><span class=p>;</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.kafka.common.serialization.Serializer</span><span class=p>;</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JSONSerde</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Serializer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Deserializer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Serde</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ObjectMapper</span><span class=w> </span><span class=n>OBJECT_MAPPER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectMapper</span><span class=p>();</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>;</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>JSONSerde</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>cn</span><span class=p>){</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>className</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cn</span><span class=p>;</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>    </span><span class=c1>//..</span>
</code></pre></div> <p>An example of specific usage for this class is the <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/main/java/ibm/gse/eda/stores/infra/events/StoreSerdes.java>StoreSerdes</a> class.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>StoreSerdes</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Serde</span><span class=o>&lt;</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ItemTransactionSerde</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JSONSerde</span><span class=o>&lt;</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ItemTransaction</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getCanonicalName</span><span class=p>());</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>    </span><span class=c1>// ..</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=p>}</span>
</code></pre></div> <p>Using the StoreSerdes, the test topic declarations in the TestCase class, are using the serdes like:</p> <div class=highlight><span class=filename>setup method</span><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1>// Key of the record is a String, value is a ItemTransaction </span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=n>inputTopic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testDriver</span><span class=p>.</span><span class=na>createInputTopic</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>StringSerializer</span><span class=p>(),</span><span class=w> </span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>        </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>().</span><span class=na>serializer</span><span class=p>());</span><span class=w> </span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=n>outputTopic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testDriver</span><span class=p>.</span><span class=na>createOutputTopic</span><span class=p>(</span><span class=n>outTopicName</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>StringDeserializer</span><span class=p>(),</span><span class=w>  </span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>        </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>().</span><span class=na>deserializer</span><span class=p>());</span>
</code></pre></div> <p>Now some guidances of what the Stream topology should look like:</p> <ul> <li>Think to build a Kstream from the input stream</li> <li>The record should have key and value</li> <li>use filter and predicate to test if value.storeName has no value or value.sku is empty or null then drop the message</li> <li>generate output to a topic</li> <li>Think to chain the functions to get accurate result</li> </ul> <p>Use Test Driven Development to build tests before the topology, but here tests are already defined for you.</p> <div class=highlight><span class=filename>Happy Path Test</span><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=w>    </span><span class=nd>@Test</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendValidRecord</span><span class=p>(){</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>        </span><span class=n>ItemTransaction</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ItemTransaction</span><span class=p>(</span><span class=s>&quot;Store-1&quot;</span><span class=p>,</span><span class=s>&quot;Item-1&quot;</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=p>.</span><span class=na>RESTOCK</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mf>33.2</span><span class=p>);</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>        </span><span class=n>inputTopic</span><span class=p>.</span><span class=na>pipeInput</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=na>storeName</span><span class=p>,</span><span class=w> </span><span class=n>item</span><span class=p>);</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>outputTopic</span><span class=p>.</span><span class=na>getQueueSize</span><span class=p>(),</span><span class=w> </span><span class=n>equalTo</span><span class=p>(</span><span class=mi>1L</span><span class=p>)</span><span class=w> </span><span class=p>);</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>        </span><span class=n>ItemTransaction</span><span class=w> </span><span class=n>filteredItem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>outputTopic</span><span class=p>.</span><span class=na>readValue</span><span class=p>();</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>filteredItem</span><span class=p>.</span><span class=na>storeName</span><span class=p>,</span><span class=w> </span><span class=n>equalTo</span><span class=p>(</span><span class=s>&quot;Store-1&quot;</span><span class=p>));</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>filteredItem</span><span class=p>.</span><span class=na>sku</span><span class=p>,</span><span class=w> </span><span class=n>equalTo</span><span class=p>(</span><span class=s>&quot;Item-1&quot;</span><span class=p>));</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span><span class=p>}</span>
</code></pre></div> <ul> <li>Here is a typical trace: the id of the transaction is a timestamp as long, so those values will change.</li> </ul> <div class=highlight><span class=filename>Expected execution trace</span><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=nl>Topologies</span><span class=p>:</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>   </span><span class=n>Sub</span><span class=o>-</span><span class=n>topology</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>    </span><span class=n>Source</span><span class=p>:</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>SOURCE</span><span class=o>-</span><span class=mo>0000000000</span><span class=w> </span><span class=p>(</span><span class=n>topics</span><span class=p>:</span><span class=w> </span><span class=o>[</span><span class=n>my</span><span class=o>-</span><span class=n>input</span><span class=o>-</span><span class=n>topic</span><span class=o>]</span><span class=p>)</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>      </span><span class=o>--&gt;</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>PEEK</span><span class=o>-</span><span class=mo>0000000001</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>    </span><span class=n>Processor</span><span class=p>:</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>PEEK</span><span class=o>-</span><span class=mo>0000000001</span><span class=w> </span><span class=p>(</span><span class=n>stores</span><span class=p>:</span><span class=w> </span><span class=o>[]</span><span class=p>)</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>      </span><span class=o>--&gt;</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>FILTER</span><span class=o>-</span><span class=mo>0000000002</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>      </span><span class=o>&lt;--</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>SOURCE</span><span class=o>-</span><span class=mo>0000000000</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>    </span><span class=n>Processor</span><span class=p>:</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>FILTER</span><span class=o>-</span><span class=mo>0000000002</span><span class=w> </span><span class=p>(</span><span class=n>stores</span><span class=p>:</span><span class=w> </span><span class=o>[]</span><span class=p>)</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>      </span><span class=o>--&gt;</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>PEEK</span><span class=o>-</span><span class=mo>0000000003</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>      </span><span class=o>&lt;--</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>PEEK</span><span class=o>-</span><span class=mo>0000000001</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>    </span><span class=n>Processor</span><span class=p>:</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>PEEK</span><span class=o>-</span><span class=mo>0000000003</span><span class=w> </span><span class=p>(</span><span class=n>stores</span><span class=p>:</span><span class=w> </span><span class=o>[]</span><span class=p>)</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>      </span><span class=o>--&gt;</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>SINK</span><span class=o>-</span><span class=mo>0000000004</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>      </span><span class=o>&lt;--</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>FILTER</span><span class=o>-</span><span class=mo>0000000002</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>    </span><span class=n>Sink</span><span class=p>:</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>SINK</span><span class=o>-</span><span class=mo>0000000004</span><span class=w> </span><span class=p>(</span><span class=n>topic</span><span class=p>:</span><span class=w> </span><span class=n>my</span><span class=o>-</span><span class=n>output</span><span class=o>-</span><span class=n>topic</span><span class=p>)</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>      </span><span class=o>&lt;--</span><span class=w> </span><span class=n>KSTREAM</span><span class=o>-</span><span class=n>PEEK</span><span class=o>-</span><span class=mo>0000000003</span>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=p>....</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=n>PRE</span><span class=o>-</span><span class=n>FILTER</span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=o>=</span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=mi>1653431482009</span><span class=w> </span><span class=n>Store</span><span class=p>:</span><span class=w> </span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Item</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=n>Type</span><span class=p>:</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=n>Quantity</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>}</span>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=n>PRE</span><span class=o>-</span><span class=n>FILTER</span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=o>=</span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=mi>1653431482107</span><span class=w> </span><span class=n>Store</span><span class=p>:</span><span class=w> </span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Item</span><span class=p>:</span><span class=w> </span><span class=n>Item</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Type</span><span class=p>:</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=n>Quantity</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>}</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=n>POST</span><span class=o>-</span><span class=n>FILTER</span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=o>=</span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=mi>1653431482107</span><span class=w> </span><span class=n>Store</span><span class=p>:</span><span class=w> </span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Item</span><span class=p>:</span><span class=w> </span><span class=n>Item</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Type</span><span class=p>:</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=n>Quantity</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>}</span>
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=n>PRE</span><span class=o>-</span><span class=n>FILTER</span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=o>=</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=mi>1653431482114</span><span class=w> </span><span class=n>Store</span><span class=p>:</span><span class=w>  </span><span class=n>Item</span><span class=p>:</span><span class=w> </span><span class=n>Item</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Type</span><span class=p>:</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=n>Quantity</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>}</span>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=n>PRE</span><span class=o>-</span><span class=n>FILTER</span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=o>=</span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=mi>1653431482116</span><span class=w> </span><span class=n>Store</span><span class=p>:</span><span class=w> </span><span class=n>Store</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Item</span><span class=p>:</span><span class=w>  </span><span class=n>Type</span><span class=p>:</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=n>Quantity</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>}</span>
<a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=n>PRE</span><span class=o>-</span><span class=n>FILTER</span><span class=p>:</span><span class=w> </span><span class=n>key</span><span class=o>=</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=mi>1653431482118</span><span class=w> </span><span class=n>Store</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=n>Item</span><span class=p>:</span><span class=w> </span><span class=n>Item</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=n>Type</span><span class=p>:</span><span class=w> </span><span class=n>RESTOCK</span><span class=w> </span><span class=n>Quantity</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=p>}</span>
</code></pre></div> <details class=-> <summary>Solution</summary> <p>The topology looks like <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>     </span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>(),</span><span class=w>  </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>()));</span><span class=w>  </span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>    </span><span class=n>items</span><span class=p>.</span><span class=na>peek</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;PRE-FILTER: key=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, value= {&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;}&quot;</span><span class=p>))</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>            </span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>storeName</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>storeName</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>sku</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>sku</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()))</span><span class=w> </span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>        </span><span class=p>.</span><span class=na>peek</span><span class=p>((</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&quot;POST-FILTER: key=&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, value= {&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;}&quot;</span><span class=p>))</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>        </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=n>outTopicName</span><span class=p>);</span>
</code></pre></div></p> </details> <h3 id=exercise-3-dead-letter-topic>Exercise 3: Dead letter topic<a class=headerlink href=#exercise-3-dead-letter-topic title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> from the previous example, we would like to route the messages with errors to a dead letter topic, for future processing. May be a human intervention? The dead letter topic is a classical integration pattern, and when dealing with Kafka and streaming it looks like:</p> <p><img alt src=images/dlq.png></p> <p>Transform the previous topology to support branches and routing the records in error to a dead letter topic. </p> <p>You should use the <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/test/java/ut/TestDeadLetterTopic.java>TestDeadLetterTopic</a> test class, and implement the Kafka Streams topology in the buildTopologyFlow() method:</p> <p>Some guidances:</p> <ul> <li>Define a dead letter topic</li> <li>Create a [StreamsBuilder]: Builder for Kafka Streams topology</li> <li>Create a KStream with key as string and value as ItemTransaction</li> <li>Use the concept of <a href=./kstream/#kstream-api>branches</a> by splitting the input stream</li> <li>Use lambda function for testing condition on <code>sku</code> and <code>storeName</code> attributes</li> <li>Output the branches to topics</li> </ul> <details class=-> <summary>Solution</summary> <ul> <li>Dead letter topic declaration <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=kd>private</span><span class=w>  </span><span class=kd>static</span><span class=w> </span><span class=n>TestOutputTopic</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=n>dlTopic</span><span class=p>;</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>deadLetterTopicName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;dl-topic&quot;</span><span class=p>;</span>
</code></pre></div></li> <li>Define topology <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=kd>final</span><span class=w> </span><span class=n>StreamsBuilder</span><span class=w> </span><span class=n>builder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StreamsBuilder</span><span class=p>();</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>    </span><span class=c1>// 1- get the input stream</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>        </span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>(),</span><span class=w>  </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>()));</span><span class=w>  </span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=c1>// 2 build branches</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>branches</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>items</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>Named</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;B-&quot;</span><span class=p>))</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=p>.</span><span class=na>branch</span><span class=p>((</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>    </span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>storeName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w>  </span><span class=n>v</span><span class=p>.</span><span class=na>storeName</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>sku</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=na>sku</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()),</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>    </span><span class=n>Branched</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;wrong-tx&quot;</span><span class=p>)</span>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=p>).</span><span class=na>defaultBranch</span><span class=p>(</span><span class=n>Branched</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&quot;good-tx&quot;</span><span class=p>));</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=c1>// Generate to output topic</span>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=n>branches</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&quot;B-good-tx&quot;</span><span class=p>).</span><span class=na>to</span><span class=p>(</span><span class=n>outTopicName</span><span class=p>);</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=n>branches</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&quot;B-wrong-tx&quot;</span><span class=p>).</span><span class=na>to</span><span class=p>(</span><span class=n>deadLetterTopicName</span><span class=p>);</span>
</code></pre></div></li> <li>Define output topic in setup() <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=n>dlTopic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testDriver</span><span class=p>.</span><span class=na>createOutputTopic</span><span class=p>(</span><span class=n>deadLetterTopicName</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringDeserializer</span><span class=p>(),</span><span class=w>  </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>().</span><span class=na>deserializer</span><span class=p>());</span>
</code></pre></div></li> </ul> </details> <h3 id=exercice-4-using-ktable>Exercice 4 - Using Ktable<a class=headerlink href=#exercice-4-using-ktable title="Permanent link">&para;</a></h3> <p><strong>Problem:</strong> now you want to group record in table and keep last item transaction per store</p> <p><strong>Input examples:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=p>{</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>9</span><span class=p>,</span><span class=nt>&quot;price&quot;</span><span class=p>:</span><span class=mf>30.0</span><span class=p>,</span><span class=nt>&quot;quantity&quot;</span><span class=p>:</span><span class=mi>10</span><span class=p>,</span><span class=nt>&quot;sku&quot;</span><span class=p>:</span><span class=s2>&quot;Item_1&quot;</span><span class=p>,</span><span class=nt>&quot;storeName&quot;</span><span class=p>:</span><span class=s2>&quot;Store_1&quot;</span><span class=p>,</span><span class=nt>&quot;timestamp&quot;</span><span class=p>:</span><span class=s2>&quot;2022-05-19T16:22:37.287937&quot;</span><span class=p>,</span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;RESTOCK&quot;</span><span class=p>}</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=p>{</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span><span class=nt>&quot;price&quot;</span><span class=p>:</span><span class=mf>10.0</span><span class=p>,</span><span class=nt>&quot;quantity&quot;</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span><span class=nt>&quot;sku&quot;</span><span class=p>:</span><span class=s2>&quot;Item_3&quot;</span><span class=p>,</span><span class=nt>&quot;storeName&quot;</span><span class=p>:</span><span class=s2>&quot;Store_1&quot;</span><span class=p>,</span><span class=nt>&quot;timestamp&quot;</span><span class=p>:</span><span class=s2>&quot;2022-05-12T23:13:31.338671&quot;</span><span class=p>,</span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;SALE&quot;</span><span class=p>}</span>
</code></pre></div> <p>Expected result in a Ktable - store:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>Item_3
</code></pre></div> <p><strong>Guidances</strong></p> <ul> <li> <p>The input topic is keyed by the SKU so we need to rekey to store name: </p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=w>    </span><span class=n>inputTopic</span><span class=p>.</span><span class=na>pipeInput</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=na>sku</span><span class=p>,</span><span class=w> </span><span class=n>item</span><span class=p>);</span>
</code></pre></div> </li> <li> <p>Create a Kstream from the items stream</p> </li> <li>use <code>map</code> to generate new KeyValue with key being the storeName</li> <li>Create a Ktable from the output of the map</li> <li>Use materialized view to keep data in a state store (KeyValueStore)</li> </ul> <details class=-> <summary>Solution</summary> <ul> <li>The topology looks like <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=w>    </span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>(),</span><span class=w>  </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>()));</span><span class=w>  </span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=n>KTable</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=n>lastItemInStore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>items</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>((</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>KeyValue</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>storeName</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>);</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=w>            </span><span class=p>}).</span><span class=na>toTable</span><span class=p>(</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=w>                    </span><span class=n>Materialized</span><span class=p>.</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>ItemTransaction</span><span class=p>,</span><span class=w> </span><span class=n>KeyValueStore</span><span class=o>&lt;</span><span class=n>Bytes</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]&gt;&gt;</span><span class=n>as</span><span class=p>(</span><span class=n>storeName</span><span class=p>)</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=w>            </span><span class=p>.</span><span class=na>withKeySerde</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>()).</span><span class=na>withValueSerde</span><span class=p>(</span><span class=w> </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>()));</span>
</code></pre></div></li> <li>The trace for the topology: <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>Topologies:
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>Sub-topology: 0
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>Source: KSTREAM-SOURCE-0000000000 (topics: [my-input-topic])
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>  --&gt; KSTREAM-MAP-0000000001
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>Processor: KSTREAM-MAP-0000000001 (stores: [])
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>  --&gt; KSTREAM-FILTER-0000000004
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>  &lt;-- KSTREAM-SOURCE-0000000000
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>Processor: KSTREAM-FILTER-0000000004 (stores: [])
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a>  --&gt; KSTREAM-SINK-0000000003
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a>  &lt;-- KSTREAM-MAP-0000000001
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>Sink: KSTREAM-SINK-0000000003 (topic: KSTREAM-TOTABLE-0000000002-repartition)
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>  &lt;-- KSTREAM-FILTER-0000000004
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a>
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>Sub-topology: 1
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a>Source: KSTREAM-SOURCE-0000000005 (topics: [KSTREAM-TOTABLE-0000000002-repartition])
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a>  --&gt; KSTREAM-TOTABLE-0000000002
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a>Processor: KSTREAM-TOTABLE-0000000002 (stores: [ItemTable])
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a>  --&gt; none
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a>  &lt;-- KSTREAM-SOURCE-0000000005
</code></pre></div></li> </ul> </details> <h3 id=more-examples>More examples<a class=headerlink href=#more-examples title="Permanent link">&para;</a></h3> <p>For your information here are some more test classes that demonstrate some streaming examples:</p> <ul> <li><a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/test/java/ut/TestAccumulateItemSold.java>TestAccumulateItemSold</a> to demonstrate counting item sold event per sku. It groups by sku, and then count and emit events. Without Ktable caching the sequence of output records is emitted for key that represent changes in the resulting aggregation table.</li> </ul> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=w>    </span><span class=n>KStream</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>ItemTransaction</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>stream</span><span class=p>(</span><span class=n>inTopicName</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>        </span><span class=n>Consumed</span><span class=p>.</span><span class=na>with</span><span class=p>(</span><span class=n>Serdes</span><span class=p>.</span><span class=na>String</span><span class=p>(),</span><span class=w>  </span><span class=n>StoreSerdes</span><span class=p>.</span><span class=na>ItemTransactionSerde</span><span class=p>()));</span><span class=w> </span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>        </span><span class=c1>// 2- to compute aggregate we need to group records by key to create KGroupTable or stream</span>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>        </span><span class=c1>// here we group the records by their current key into a KGroupedStream </span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>        </span><span class=n>KTable</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>countedItems</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>items</span>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w>        </span><span class=p>.</span><span class=na>filter</span><span class=p>((</span><span class=n>k</span><span class=p>,</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>ItemTransaction</span><span class=p>.</span><span class=na>SALE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>type</span><span class=p>))</span>
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=w>        </span><span class=p>.</span><span class=na>groupByKey</span><span class=p>()</span>
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=w>        </span><span class=c1>// 3- change the stream type from KGroupedStream&lt;String, ItemTransaction&gt; to KTable&lt;String, Long&gt;</span>
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>        </span><span class=p>.</span><span class=na>count</span><span class=p>();</span>
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a>
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=w>    </span><span class=c1>// Generate to output topic</span>
<a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=w>    </span><span class=n>countedItems</span><span class=p>.</span><span class=na>toStream</span><span class=p>().</span><span class=na>to</span><span class=p>(</span><span class=n>outTopicName</span><span class=p>);</span>
</code></pre></div> <h2 id=final-store-inventory-exercice>Final store inventory exercice<a class=headerlink href=#final-store-inventory-exercice title="Permanent link">&para;</a></h2> <p>As decided during the system design, you need now to implement the proof of concept around streaming restock or sale transaction.</p> <h3 id=problem-statement>Problem statement<a class=headerlink href=#problem-statement title="Permanent link">&para;</a></h3> <p>How to get the real-time view of the inventory per store?</p> <p>The <a href=https://github.com/ibm-cloud-architecture/eda-tech-academy/blob/main/lab2/refarch-eda-store-inventory/src/main/java/ibm/gse/eda/stores/domain/ItemTransaction.java>ItemTransaction.java</a> represents the message structure of the input topic. Below is an extract of this definition:</p> <p>Here is an example of json message you may see in a topic:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=p>{</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>9</span><span class=p>,</span><span class=nt>&quot;price&quot;</span><span class=p>:</span><span class=mf>30.0</span><span class=p>,</span><span class=nt>&quot;quantity&quot;</span><span class=p>:</span><span class=mi>10</span><span class=p>,</span><span class=nt>&quot;sku&quot;</span><span class=p>:</span><span class=s2>&quot;Item_1&quot;</span><span class=p>,</span><span class=nt>&quot;storeName&quot;</span><span class=p>:</span><span class=s2>&quot;Store_5&quot;</span><span class=p>,</span><span class=nt>&quot;timestamp&quot;</span><span class=p>:</span><span class=s2>&quot;2022-05-19T16:22:37.287937&quot;</span><span class=p>,</span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;RESTOCK&quot;</span><span class=p>}</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=p>{</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span><span class=nt>&quot;price&quot;</span><span class=p>:</span><span class=mf>10.0</span><span class=p>,</span><span class=nt>&quot;quantity&quot;</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span><span class=nt>&quot;sku&quot;</span><span class=p>:</span><span class=s2>&quot;Item_3&quot;</span><span class=p>,</span><span class=nt>&quot;storeName&quot;</span><span class=p>:</span><span class=s2>&quot;Store_1&quot;</span><span class=p>,</span><span class=nt>&quot;timestamp&quot;</span><span class=p>:</span><span class=s2>&quot;2022-05-12T23:13:31.338671&quot;</span><span class=p>,</span><span class=nt>&quot;type&quot;</span><span class=p>:</span><span class=s2>&quot;SALE&quot;</span><span class=p>}</span>
</code></pre></div> <p>We need to compute aggregate for each store level. For example the outcome may look like:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=p>{</span><span class=nt>&quot;storeName&quot;</span><span class=p>:</span><span class=s2>&quot;Store_1&quot;</span><span class=p>,</span><span class=nt>&quot;stock&quot;</span><span class=p>:{</span><span class=nt>&quot;Item_3&quot;</span><span class=p>:</span><span class=mi>20</span><span class=p>,</span><span class=nt>&quot;Item_2&quot;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&quot;Item_1&quot;</span><span class=p>:</span><span class=mi>20</span><span class=p>}}</span>
</code></pre></div> <p>Events could be RESTOCK or SALE. The <code>type</code> attribute defines this. <code>sku</code> represents the item identifier.</p> <p>The input topic is <code>items</code> and the output topic is <code>store.inventory</code>. We assume ItemTransaction fields are all present, so the streaming logic does not need to assess data quality.</p> <h3 id=design-questions>Design questions<a class=headerlink href=#design-questions title="Permanent link">&para;</a></h3> <ul> <li>What is the data model you need to use to keep store inventory?</li> <li>What event will be produced to the <code>store.inventory</code> topic?</li> <li>We need to process 5 million messages per day. Day is from 6:00 am to 10 pm every day.</li> </ul> <details class=-> <summary>Some hints</summary> <ul> <li>Define a New class to support keeping Store and a Map<string, lon> for items and current stock value. This class will be the event structure to get to the output topic</li> <li>Use a method to update the quantity of an existing inventory instance with a new retrieved event</li> <li>Use <a href=./kstream/#kstream>KStream aggregate function</a> to create new entry and update existing store entry</li> </ul> </details> <p><a href=lab2-sol/ >Solution review and code explanation&gt;&gt;</a></p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.tabs", "navigation.instant", "navigation.sections", "navigation.expand", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.51d95adb.min.js></script> </body> </html>